#!/usr/bin/env bash
# –°–∫—Ä–∏–ø—Ç —Å–±–æ—Ä–∫–∏ Django-–ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è Render
# –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø—Ä–∏ –¥–µ–ø–ª–æ–µ (–Ω–µ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ)

set -o errexit  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ
set -o pipefail # –í—ã—Ö–æ–¥ –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤ –ø–∞–π–ø–µ
set -o nounset  # –í—ã—Ö–æ–¥ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –Ω–µ–æ–±—ä—è–≤–ª–µ–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

echo "=========================================="
echo "üöÄ –ù–ê–ß–ê–õ–û –°–ë–û–†–ö–ò DJANGO –ü–†–û–ï–ö–¢–ê"
echo "=========================================="
echo "–í—Ä–µ–º—è: $(date)"
echo "Python: $(python --version)"
echo "Pip: $(pip --version)"
echo ""

# 1. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–ê–ö–ï–¢–û–í –ò –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
echo "1. üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π Python..."
pip install --upgrade pip
pip install -r requirements.txt

# 2. –°–û–ó–î–ê–ù–ò–ï –ú–ï–î–ò–ê-–î–ò–†–ï–ö–¢–û–†–ò–ô
echo "2. üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–¥–∏–∞-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
# –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –º–µ–¥–∏–∞-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ –ø–æ–¥–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p media/shop_items
mkdir -p media/uploaded_images
mkdir -p media/tmp

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å—å
touch media/shop_items/.test_write && rm media/shop_items/.test_write
echo "‚úÖ –ú–µ–¥–∏–∞-–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# 3. –ü–†–û–í–ï–†–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–ê–ó–ï –î–ê–ù–ù–´–• (Supabase)
echo "3. üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase..."
if python -c "
import os, django
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'TeddyTale.settings')
django.setup()
from django.db import connection
try:
    connection.ensure_connection()
    print('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase —É—Å–ø–µ—à–Ω–æ')
except Exception as e:
    print(f'‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase: {e}')
    exit(1)
"; then
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–æ—Å—Ç—É–ø–Ω–∞"
else
    echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î"
    # –ù–µ –≤—ã—Ö–æ–¥–∏–º —Å –æ—à–∏–±–∫–æ–π - –≤–æ–∑–º–æ–∂–Ω–æ, –º–∏–≥—Ä–∞—Ü–∏–∏ –µ—â—ë –Ω–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
fi

# 4. –°–û–ë–û–† –°–¢–ê–¢–ò–ß–ï–°–ö–ò–• –§–ê–ô–õ–û–í
echo "4. üé® –°–±–æ—Ä —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
python manage.py collectstatic --noinput --clear

echo ""
echo "=========================================="
echo "‚úÖ –°–ë–û–†–ö–ê –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù–ê"
echo "=========================================="