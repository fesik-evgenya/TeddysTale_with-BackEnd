services:
  - type: web
    name: teddystale
    runtime: python
    plan: free
    rootDir: TeddyTale
    envVars:
      - key: PYTHONPATH
        value: "/opt/render/project/src/TeddyTale"
      - key: DJANGO_SETTINGS_MODULE
        value: "TeddyTale.settings"
      - key: DEBUG
        value: "True"  # Временно включаем для отладки
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: 4
      - key: DATABASE_URL
        fromDatabase:
          name: teddystaledb
          property: connectionString
      - key: ALLOWED_HOSTS
        value: ".onrender.com,localhost,127.0.0.1"  # Используем маску
      - key: CSRF_TRUSTED_ORIGINS  # Добавляем для CSRF
        value: "https://*.onrender.com"
      - key: DISABLE_COLLECTSTATIC
        value: "0"
      - key: PYTHON_VERSION
        value: "3.11.0"

    buildCommand: |
      echo "=== Начало сборки ==="
      echo "Текущая директория: $(pwd)"
      echo "Python версия: $(python --version)"
      
      # Установка зависимостей
      pip install --upgrade pip
      pip install -r requirements.txt
      
      # Создаем директории для логов
      mkdir -p logs
      
      # Сбор статических файлов
      python manage.py collectstatic --noinput --clear
      
      # Применение миграций
      python manage.py makemigrations --noinput
      python manage.py migrate --noinput
      
      # Создание суперпользователя
      echo "from django.contrib.auth import get_user_model; User = get_user_model(); \
            if not User.objects.filter(username='admin').exists(): \
                User.objects.create_superuser('admin', 'admin@example.com', 'admin123'); \
                print('✅ Суперпользователь создан'); \
            else: \
                print('✅ Суперпользователь уже существует')" | python manage.py shell
      
      echo "=== Завершение сборки ==="

    startCommand: |
      echo "=== Запуск приложения ==="
      echo "Текущая директория: $(pwd)"
      echo "DJANGO_SETTINGS_MODULE: $DJANGO_SETTINGS_MODULE"
      echo "DEBUG: $DEBUG"
      
      # Запуск Gunicorn
      gunicorn TeddyTale.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers $WEB_CONCURRENCY \
        --timeout 120 \
        --access-logfile - \
        --error-logfile -

    healthCheckPath: /
    autoDeploy: true

databases:
  - name: teddystaledb
    plan: free
    databaseName: teddystale
    user: teddystale_user