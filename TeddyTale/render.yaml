services:
  - type: web
    name: teddystale
    runtime: python
    plan: free
    rootDir: TeddyTale  # Все команды выполняются из этой директории
    envVars:
      - key: PYTHONPATH
        value: "/opt/render/project/src/TeddyTale"
      - key: DJANGO_SETTINGS_MODULE
        value: "TeddyTale.settings"  # Исправлен путь к настройкам
      - key: DEBUG
        value: "False"
      - key: DJANGO_SECRET_KEY
        generateValue: true
      - key: WEB_CONCURRENCY
        value: 4
      - key: DATABASE_URL  # Добавлено подключение к базе данных
        fromDatabase:
          name: teddystaledb
          property: connectionString
      - key: ALLOWED_HOSTS  # Добавлены разрешенные хосты
        value: "teddystale.onrender.com,localhost,127.0.0.1"
      - key: DISABLE_COLLECTSTATIC  # Включаем сбор статики
        value: "0"
      - key: PYTHON_VERSION
        value: "3.11.0"

    buildCommand: |
      echo "=== Начало сборки ==="
      echo "Текущая директория: $(pwd)"
      echo "Python версия: $(python --version)"
      echo "PIP версия: $(pip --version)"
      
      # Установка зависимостей
      pip install -r requirements.txt
      
      # Сбор статических файлов
      python manage.py collectstatic --noinput
      
      # Применение миграций
      python manage.py makemigrations --noinput
      python manage.py migrate --noinput
      
      # Создание суперпользователя (если не существует)
      echo "from django.contrib.auth import get_user_model; User = get_user_model(); \
            if not User.objects.filter(username='admin').exists(): \
                User.objects.create_superuser('admin', 'admin@example.com', 'admin123'); \
                print('✅ Суперпользователь создан'); \
            else: \
                print('✅ Суперпользователь уже существует')" | python manage.py shell
      
      echo "=== Завершение сборки ==="

    startCommand: |
      echo "=== Запуск приложения ==="
      echo "Текущая директория: $(pwd)"
      echo "DJANGO_SETTINGS_MODULE: $DJANGO_SETTINGS_MODULE"
      echo "DATABASE_URL: $DATABASE_URL"
      echo "ALLOWED_HOSTS: $ALLOWED_HOSTS"
      
      # Запуск Gunicorn
      gunicorn TeddyTale.wsgi:application \
        --bind 0.0.0.0:$PORT \
        --workers $WEB_CONCURRENCY \
        --timeout 120 \
        --access-logfile - \
        --error-logfile -

    # Health Check для мониторинга
    healthCheckPath: /
    autoDeploy: true

databases:
  - name: teddystaledb
    plan: free
    databaseName: teddystale
    user: teddystale_user
    ipAllowList: []  # Разрешает все подключения (можно ограничить)

# Опционально: добавляем переменные окружения из файла
# envVarFiles:
#   - source: render
#     type: auto